# AWS Vpc管理

<!-- more -->

## 一、名词解释

+ **VPC**: 您的 AWS 账户的虚拟网络，它在逻辑上与 AWS 云中的其他虚拟网络隔绝。
+ **子网**: 子网是您的 VPC 内的 IP 地址范围。
+ **路由表**: 路由表中包含一系列被称为路由的规则，可用于判断网络流量的导向目的地。您的 VPC 中的每个子网必须与一个路由表关联;路由表控制子网的路由。一个子网一次只能与一个路由表关联，但您可以将多个子网与同一路由表 关联。
+ **Internet网关**: Internet 网关是一种横向扩展、支持冗余且高度可用的 VPC 组件，可实现 VPC 中的实例与 Internet 之间的通信。 
+ **NAT网关**: NAT网关允许私有子网中的实例连接到 Internet 或其他 AWS 服务，但是阻止 Internet 发起与这些实例的连接。 
+ **对等连接**: 对等连接是两个 VPC 之间的网络连接，通过此连接，您可以使用私有 IPv4 地址或 IPv6 地址在两个 VPC 之间路由流量。 
+ **网络ACL**: 网络访问控制列表，用作防火墙来控制进出一个或多个子网的流量。 
+ **客户网关**: 客户网关是在您需要将不同VPC之间通过特定线路(可以是物理线路和internet线路)进行类内网通信时，AWS对端使用的定位 标记。
+ **虚拟专用网关**:客户网关与AWS通信时，AWS所处端即为虚拟专用网关。

## 二、VPC场景

1. 单个公有子网的VPC;
2. 公有子网和私有子网(NAT)的VPC;(默认创建这个) 
3. 公有子网、私有子网和硬件VPN访问的VPC;
4. 私有子网和硬件VPN访问的VPC;

## 三、VPC架构方案

1. VPC名字按照vpc-node-序列号格式命名（或按你的需求标记命名）;
2. AWS VG区域子网默认从10.0.0.0/16 至 10.255.0.0/16共16个VPC，对一般公司已可支撑其应用；
3. 每个VPC若无特殊要求，都会包含多个公有子网和私有子网;子网使用255.255.255.0的掩码，每个类型子网要求尽量使用不同可用区，具体规划如下:

    | 子网类别       | 子网                         | 用途              | 类型      | 出口网关       | 备注                                    |
    | -------------- | ---------------------------- | ----------------- | --------- | -------------- | --------------------------------------- |
    | 运维子网       | 10.0.0.0/24至10.0.7.0/24     | 运维子网组        | 公有子网  | 走Internet网关 |
    | 公共DB子网     | 10.0.8.0/24至10.0.15.0/24    | 公共对外DB子网组 | 公有子网  | 走Internet网关 |                                         |
    | 公共ELB子网    | 10.0.16.0/24至10.0.23.0/24   | 公共对外ELB子网组 | 公有子网  | 走Internet网关 |                                         |
    | 私有DB子网     | 10.0.24.0/24至10.0.31.0/24   | 私有DB子网组      | 私有子网  | 走NAT网关      |                                         |
    | 私有ELB子网    | 10.0.32.0/24至10.0.39.0/24   | 私有ELB子网组   | 私有子网  | 走NAT网关      |                                         |
    | 预留子网组     | 10.0.40.0/24至10.0.127.0/24  | 预留子网组        | 待定      | 待定           | 预留88个子网用于后期扩充               |
    | 应用服务子网组 | 10.0.128.0/24至10.0.255.0/24 | 应用服务子网组    | 私有子网 | 走NAT网关      | 128个子网用于应用服务，具体分类可自定义 |

4. 子网路由表:公有子网访问Internet走Internet网关，私有子网访问Internet走NAT网关。其中私有ELB子网组，不配置访 问Internet相关项;
5. NAT网关:默认不同子网组使用不同NAT出口，同一子网组的所有子网共用NAT出口;
6. 网络ACL:每个子网组关联一个网络ACL规则表，具体要求如下

    | 子网组         | 入站             | 出站             | 备注                                                                                             |
    | -------------- | ---------------- | ---------------- | ------------------------------------------------------------------------------------------------ |
    | 运维子网组     | 根据公司要求配置 | 根据公司要求配置 | 22限制为只能公司出口IP入站                                                                       |
    | 公共DB子网组   | 根据公司要求配置 | 根据公司要求配置 | 一般只需配置以下接口即可。1433: MS SQL; 1521: Oracle ;3306: Mysql ;5432: PostgreSQL; 6379: Redis |
    | 公共ELB子网    | 根据公司要求配置 | 根据公司要求配置 | 一般只需配置80、443、8080、8443端口                                                              |
    | 私有DB子网     | 根据公司要求配置 | 根据公司要求配置 | 一般只需配置以下接口即可。1433: MS SQL; 1521: Oracle ;3306: Mysql ;5432: PostgreSQL; 6379: Redis |
    | 私有ELB子网    | 根据公司要求配置 | 根据公司要求配置 | 一般只需配置80、443、8080、8443端口                                                              |
    | 应用服务子网组 | 根据公司要求配置 | 根据公司要求配置 | 一般只允许上面所有或部分子网进入                                                                 |

7. 虚拟专用网关:对有专线需求的VPC，需要配置该选项，并在路由表中，对对端IP的路由选择走虚拟网关;
8. 流日志:每个VPC必须开启流日志，并记录到与VPC同名的流日志组

## 四、创建VPC

1. 创建步骤
    + 打开链接[vpc控制台](https://console.aws.amazon.com/vpc/), 选择你想要的区域;
    + 点击启动VPC向导，选择VPC配置(默认创建带有公有和私有子网的VPC);
    + 输入网段;网段建议使用16，可用IP有65000+，可有256个子网;
    + VPC名称、公有子网网段、可用区、子网名称，勾选“启用DNS主机名”，硬件租赁为默认，不启用ClassLink 
    + 点击创建;
2. 添加子网
    + 选择“子网”标签，点击创建子网
    + 填写子网名称，VPC选择刚刚创建的VPC，选择可用区，填写子网网段; 
    + 具体子网规划方案可参考本文章第三部分;
3. 编辑路由表
    + 选择“路由表”标签，点击创建路由表
    + 填写路由表名称，选择刚刚创建的VPC
    + 关联到子网
4. 创建网络ACL
    + 选择“网络ACL”标签，点击创建网络ACL;
    + 填写网络ACL名称，选择刚刚创建的VPC;
    + 具体规则请参考本文第三部分;
5. 关联对应子网
6. 开启流日志
    + 选择“您的VPC”标签，选择对应的VPC，点击”创建流日志“;
    + 筛选条件=”全部“， 角色= ”flowlogsRole“， 目标日志组=”vpc-node-2“;(日志组可按需修改)
    + 创建完成
7. 创建DB和缓存子网:
    + 进入RDS或ElastiCache;
    + 点击子网组或缓存子网组，创建子网;
8. 创建两个子网:
    + public-db:公共DB子网组的所有子网;
    + private-db:私有DB子网组的所有子网;